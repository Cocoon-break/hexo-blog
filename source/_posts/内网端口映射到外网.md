---
title: 内网端口映射到外网
date: 2017-08-21 15:47:00
tags: Linux
---

​	最近有一个客户想要看我们的产品，想体验一下我们的产品，需要我们提供一个小程序，于是就弄了一个小程序给客户，小程序还好说我们有现成的东西，直接给客户，麻烦的是小程序背后的服务。由于我们背后的人脸识别服务都是私有化部署的，而且这个客户只是想零时体验一下，所以将整个服务部署到公有云完全是没有必要的。但是我们内部有已经部署好的，又不想在公有云上去搭建一套。于是去咨询了下同事，是不是有什么工具可以把内网的端口暴露到公网上。然后同事就介绍了一个工具`autossh`

​	好了背景介绍完了，接下来就是去实践了。

现有两台服务器：服务器A是阿里云上的一台机器，服务器B是公司内部的一台虚拟机，这个台虚拟机必须是可以连接公网的。

<!-- more -->

1. 登录到服务B上

   ```sh
   #1.将autossh下载到服务器B上
   wget http://fossies.org/Linux/privat/autossh-1.4e.tgz
   #2.解压
   tar xzvf autossh-1.4e.tgz
   #3. 编译安装
    cd autossh-1.4e
    ./configure
    make
    make install
   #4. 生成服务器B的公钥，一会儿需要把服务器B的公钥添加到服务器A上
   ssh-keygen
   #5. 执行ssh-keygen 一路回车即可，这个会在~/.ssh目录下生成id_rsa.pub,编辑这个文件，把内容复制到一个文本文件
   vim ~/.ssh/id_rsa.pub
   ```


2. 登录到服务器A上

   ```sh
   #1.在~/.ssh目录下创建authorized_keys文件
   touch ~/.ssh/authorized_keys
   #2.编辑这个文件并将刚才从服务器A上复制的公钥粘贴到这个文件上，保存退出即可
   vim ~/.ssh/authorized_keys
   ```

3. 登录到服务器B上

   ```sh
   #1.制定需要暴露到公网端口
   autossh -M 10000 -NR 9200:localhost:9200 -i ~/.ssh/id_rsa 服务器A的用户名@服务器A的IP地址
   ```

   参数说明：-M 参数指定监听这个反向链接的端口，如果断了会自动重连

   后面的两个9200端口分别是指定公网上暴露的端口后内网暴露的端口

到了这个整个工作就完成了，这时访问公网IP的9200端口，就会访问内网中9200端口的服务。是不是很简单