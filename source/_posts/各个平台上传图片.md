---
title: 各个平台上传图片
date: 2017-06-13 10:47:00
tags: 开发随笔
---

开发时常遇到的一些上传图片操作，这里记录一下。包括android，iOS，和java后端，后面还遇到的其他语言或平台时，会进行补充

android AsyncHttpClient 上传图片,要使用[android-async-http](https://github.com/loopj/android-async-http)

```java
public void uploadImg(String filePath) {
        AsyncHttpClient asyncHttpclient = new AsyncHttpClient();
        RequestParams params = new RequestParams();
        try {
            params.put("liveness", "1");
            params.put("img", new File(filePath));// 传入照片路径
        } catch (FileNotFoundException e) {
            e.printStackTrace();
        }
        String url = "";
        asyncHttpclient.post(url, params, new AsyncHttpResponseHandler() {
            @Override
            public void onSuccess(int statusCode, Header[] headers,
                                  byte[] responseByte) {
                String successStr = new String(responseByte);
                try {

                    JSONObject jObject = new JSONObject(successStr)
                            .getJSONArray("faces").getJSONObject(0);
                  //其他省略
                } catch (JSONException e) {
                    e.printStackTrace();
                }
            }

            @Override
            public void onFailure(int statusCode, Header[] headers,
                                  byte[] responseBody, Throwable error) {
                // 上传失败
            }
        });
    }
```

<!-- more -->

iOS NSMutableURLRequest上传图片，NSMutableURLRequest是oc自带库

```objective-c
- (void) uploadImage:(NSData *)imageData{
    //字典里面装的是你要上传的内容
    NSDictionary *parameters = @{@"liveness": @"1"};
    //上传的接口
    NSString* urlstring = @"http://132.121.1.213:9000/faceid/v1/extract";
    //分界线的标识符
    NSString *TWITTERFON_FORM_BOUNDARY = @"AaB03x";
    //根据url初始化request
    NSMutableURLRequest * request = [NSMutableURLRequest requestWithURL:[NSURL URLWithString:urlstring]
                                                            cachePolicy:NSURLRequestReloadIgnoringLocalCacheData
                                                        timeoutInterval:10];
    //分界线 --AaB03x
    NSString *MPboundary=[[NSString alloc]initWithFormat:@"--%@",TWITTERFON_FORM_BOUNDARY];
    //结束符 AaB03x--
    NSString *endMPboundary=[[NSString alloc]initWithFormat:@"%@--",MPboundary];
    //	//要上传的图片
    //	UIImage *image=[params objectForKey:@"pic"];
    //得到图片的data
    //    NSData *data = UIImagePNGRepresentation(self.image);
    //http body的字符串
    NSMutableString *body=[[NSMutableString alloc]init];
    //参数的集合的所有key的集合
    NSArray *keys= [parameters allKeys];
    //遍历keys
    for(int i=0;i<[keys count];i++)
    {
        //得到当前key
        NSString *key=[keys objectAtIndex:i];
        //如果key不是img，说明value是字符类型，比如name：Boris
        if(![key isEqualToString:@"img"])
        {
            //添加分界线，换行
            [body appendFormat:@"%@\r\n",MPboundary];
            //添加字段名称，换2行
            [body appendFormat:@"Content-Disposition: form-data; name=\"%@\"\r\n\r\n",key];
            //添加字段的值
            [body appendFormat:@"%@\r\n",[parameters objectForKey:key]];
        }
    }
    ////添加分界线，换行
    [body appendFormat:@"%@\r\n",MPboundary];
    //声明img字段，文件名为boris.png
    [body appendFormat:@"Content-Disposition: form-data; name=\"img\"; filename=\"boris.png\"\r\n"];
    //声明上传文件的格式
    [body appendFormat:@"Content-Type: image/png\r\n\r\n"];
    //声明结束符：--AaB03x--
    NSString *end=[[NSString alloc]initWithFormat:@"\r\n%@",endMPboundary];
    //声明myRequestData，用来放入http body
    NSMutableData *myRequestData=[NSMutableData data];
    //将body字符串转化为UTF8格式的二进制
    [myRequestData appendData:[body dataUsingEncoding:NSUTF8StringEncoding]];
    //将image的data加入
    [myRequestData appendData:imageData];
    //加入结束符--AaB03x--
    [myRequestData appendData:[end dataUsingEncoding:NSUTF8StringEncoding]];
    //设置HTTPHeader中Content-Type的值
    NSString *content=[[NSString alloc]initWithFormat:@"multipart/form-data; boundary=%@",TWITTERFON_FORM_BOUNDARY];
    //设置HTTPHeader
    [request setValue:content forHTTPHeaderField:@"Content-Type"];
    //设置Content-Length
    [request setValue:[NSString stringWithFormat:@"%d", (int)[myRequestData length]] forHTTPHeaderField:@"Content-Length"];
    //设置http body
    [request setHTTPBody:myRequestData];
    //http method
    [request setHTTPMethod:@"POST"];
    [NSURLConnection sendAsynchronousRequest:request queue:[NSOperationQueue currentQueue] completionHandler:^(NSURLResponse *response, NSData *data, NSError *error) {
        if(data.length > 0)
        {
            
        }
    }];
}
```

java中使用httpClient 上传文件

pom.xml 中添加 httpclient

```xml
<dependency>
  <groupId>commons-httpclient</groupId>
  <artifactId>commons-httpclient</artifactId>
  <version>3.1</version>
</dependency>
```

```java
 public static String postWithFormData(String url, Map map) {
        HttpClient client = new HttpClient();
        PostMethod postMethod = new PostMethod(url);
        try {
 			String imgPath = (String) map.get("img");
            FilePart imgpart = null;
            if (imgPath != null && !imgPath.equals("")) {
               imgpart = new FilePart("img", new File(imgPath));
            }
            StringPart stringPart = new StringPart("liveness", "1");
            Part[] parts = {imgpart, stringPart};
          
            MultipartRequestEntity multipartRequestEntity = new MultipartRequestEntity(parts, new HttpMethodParams());
            postMethod.setRequestEntity(multipartRequestEntity);
            int statusCode = client.executeMethod(postMethod);
            if (statusCode != 200) {
                Map map1 = new HashMap();
                map1.put("msg", "http 请求错误");
                return new JSONObject(map1).toString();
            }
            InputStream inputStream = postMethod.getResponseBodyAsStream();
            BufferedReader reader = new BufferedReader(new InputStreamReader(inputStream));
            String line = "";
            StringBuilder sb = new StringBuilder();
            while ((line = reader.readLine()) != null) {
                sb.append(line + "\n");
            }
            inputStream.close();
            return sb.toString();
        } catch (IOException e) {
            e.printStackTrace();
            return "";
        }
    }
```

