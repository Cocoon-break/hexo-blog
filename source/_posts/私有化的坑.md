---
title: 私有化的坑
date: 2017-07-20 12:53:30
tags: 
- Linux
categories:
- Linux
---

​	最近遇到的坑确实是有点多了，这里记录一下。事情开始是这样的，想将公有云的一套工程进行私有化，因为公有云的是自己的系统，不用考虑太多的因素，想统一环境还是比较容易的，只要能够在一套环境成功运行，其他的直接copy就行。但是私有云就不行了，各个客户使用的环境都有一定的差异。私有化就是将使这个工程能够在不同的环境运行。

​	公有云的这套工程是python工程，python工程使用了一些so库。而这些so库又依赖系统的`/lib64/libc.so.6`，然后工程就报`version "GLIBC_2.14" not found`,原因是系统libc不支持GLIBC_2.14这个版本，这时我就有两个解决方案，一个是我将系统的libc.so.6 升级，还有一个我弄一个统一的环境。很显然方案一不是私有云，我总不能让我所有的客户去升级libc.so.6吧，着很显然不符合私有化。

​	在尝试方案一的过程中，我发现原来把一个Linux系统弄崩其实很简单，崩了之后各种无法使用，你只能去重装系统。你只要执行`mv /lib64/libc.so.6 /lib64/libc.so.6.bak`,你会发现接下来无论你输入什么命令都不好使了。这是因为`/lib64/libc.so.6 `是最底层的库，系统上的程序基本是依赖这个库的。所以/lib64下的so库不要轻易去动。

<!-- more -->

​	于是我去尝试了第二种方案，弄一个统一的环境，那要怎么弄呢？so 库是依赖系统的libc.so.6，我要怎么让我的这个工程的so不去依赖/lib64 下的so而是去依赖我指定的一个路径的so呢？

1.   我先用docker搭建一个可以运行工程的环境，使用docker弄了一个ubuntu的系统。以下是一些使用的命令

     ```sh
     docker pull ubuntu #获取ubuntu的镜像
     docker run -it --name kas -v /Users/wushengping/dockerUbuntu:/go -p 9001:9001 ubuntu bash #第一次以交互模式启动ubuntu，并命名为kas，同时将ubuntu系统端口9001映射到本机上
     docker ps -a #查看docker 下所有container状态
     docker start kas # 启动kas,kas是ubuntu系统镜像，只是启动并为进入交互模式
     docker exec -it kas bash #进入ubuntu 交互模式
     ```

2. 在ubuntu上可以正常运行之后，通过ldd 的命令将so依赖的系统相关的so 导出来,同时将/lib64/ld-linux-x86-64.so.2 也导出来

     ```sh
     cp `ldd xxxx.so | awk '{print $3}' | grep '^[^(]'` ~/libs
     cp /lib64/ld-linux-x86-64.so.2  ~
     ```

3. 将刚才的导出的库，传到redhats6.4系统上，然后指定工程运行所需的依赖库。

     ```sh
     ld-linux-x86-64.so.2 --library-path ./libs python xxxx #xxx表示工程的入口文件
     ```

     这时你会发现这个工程起都起不来了，并报了core dump 的错误，这时因为指定路径之后，只能通过二进制的方式去启动这个工程。而python 只是一个命令，并不是二进制的文件，无法执行。这里需要注意的是ld-linux-x86-64.so.2 只能是刚才从ubuntu导出来的文件，否则也会报core dump

4. 在第三步我们没有成功运行起来，是因为我们还缺少将python工程编译成一个二进制可执行的文件。**pyInstaller** 这个工具可以将python工程打成一个二进制的包，同时会将工程依赖的库也打进这个二进制。

     ```sh
     pyinstall -f entry.py #entry.py 是你整个工程的入口文件
     ```

     执行完成之后会生成一个dist目录，目录下有整个工程的二进制文件

5. 整个私有化的流程算是完成了交付给客户的时候包括一下文件

     - ld-linux-x86-64.so.2
     - libs 
     - 可执行的二进制文件

     当然实际交付的工程中有更多的文件，看工程是怎么规划的。这里不过多解释



本篇文章主要是记录私有化工程的一些思路，过程中遇到的很多坑。很多细节这里也不去体现了。大家自行领会。其中关于的docker的使用和pyinstaller 的安装使用，不是本篇文章的重点。可以自行谷歌