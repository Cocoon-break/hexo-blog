---
title: 身份证识别跑批脚本
date: 2018-03-21 12:53:30
index_img:
- /images/shell/idcard_front.jpg
tags:
- shell 
- Linux
categories:
- Linux
---

使用shell对文件夹进行遍历处理，最后通过markdown生成可视化的结果文件。比较适合对少量数据进行结果快速比对

- shell脚本遍历子目录及子目录下的文件，并将文件去发请求，把接口返回回来的json写入到文件中

  ```shell
  #!/bin/bash
  function getdir(){
  	url = $2
      for element in `ls $1`
      do  
          dir_or_file=$1"/"$element
          if [ -d $dir_or_file ]
          then 
              getdir $dir_or_file
          else
  	    	filepath=${dir_or_file%.*}
  	    	#不带文件后缀的文件路径
  	    	filename=${filepath//\//\_}
  	    	#把文件路径中的反斜线换成下划线
  	    	
  		    if [ -e ${dir_or_file%.*}.jpg ]
  		    then
  	     	    curl -F img=@${dir_or_file%.*}.jpg $url > idcard_result/${filename}.json	
  		    elif [ -e ${dir_or_file%.*}.png ]
  	   	    then
  				curl -F img=@${dir_or_file%.*}.png $url > idcard_result/${filename}.json
              fi
          fi  
      done
  }
  parentpath=$1
  mkdir idcard_result
  url=http://10.201.102.163:9002/faceid/v1/idcard
  #echo $parentpath http://10.201.102.163:9002/faceid/v1/idcard
  echo $url
  getdir $parentpath $url
  ```

- python 比较身份证正确答案的json文件和ocr识别结果的文件进行核对，统计是否识别正确。python版本为2.7.13。以下为check.py的源码,因为在python2.7里json.load出来的json 是unicode编码的，所以比较的时候在自己的中文中添加U。如：std[U'姓名']

  <!-- more -->

  ```python
  #!/usr/bin/env python
  # -*- coding:utf-8 -*-
  import sys
  import json
  reload(sys)
  sys.setdefaultencoding('utf-8')
  def startcheck(originfile, ocrfile):
      with open(originfile, 'r') as f:
          std = json.load(f, encoding='utf-8')

      with open(ocrfile, 'r') as f:
          rst = json.load(f, encoding='utf-8')

      result = True
      if rst['side'] == 'front':
          bd = rst['birthday']
          bd_date = bd['year'] + '年' + bd['month'] + '月' + bd['day'] + '日'
          if rst['name'] != std[U'姓名']:
              result = False
          if rst['gender'] != std[U'性别']:
              result = False
          if rst['race'] != std[U'民族']:
              result = False
          if bd_date != std[U'出生']:
              result = False
          if rst['address'] != std[U'住址']:
              result = False
          if rst['id_card_number'] != std[U'公民身份号码']:
              result = False
      else:
          if rst['issued_by'] != std[U'签发机关']:
              result = False
          if rst['valid_date'] != std[U'有效期']:
              result = False
      strResult = str(result)
      content = '%s,%s,%s,\n' % (originfile, ocrfile, strResult)
      with open('./check_result.csv', 'a') as f:
          f.write(content)

  if __name__ == '__main__':
      originfile_path = sys.argv[1]
      print 'originfile_path:::', originfile_path
      ocrfile_path = sys.argv[2]
      print 'ocrfile_path:::', ocrfile_path
      startcheck(originfile_path, ocrfile_path)

  ```

  ```shell
  python check.py real.json ocr.json
  ```

  real.json，以下身份证信息均为非真实身份证

  ```json
  {
    "住址": "山东省招远市温泉路309号",
    "姓名": "杜英男",
    "民族": "汉",
    "性别": "女",
    "公民身份号码": "230122195807160467",
    "出生": "1988年7月16日"
  }
  ```

  ocr.json

  ```json
  {
    "address": "湖南省长沙县安沙镇泗洲村龙口组337号",
    "address_confidence": [],
    "birthday": {
      "day": "11",
      "day_confidence": [],
      "month": "2",
      "month_confidence": [],
      "year": "1994",
      "year_confidence": []
    },
    "card_bound": {},
    "gender": "男",
    "gender_confidence": [],
    "head_rect": {},
    "id_card_number": "430121198402117321",
    "idnumber_confidence": [],
    "name": "王威一",
    "name_confidence": [],
    "race": "汉",
    "race_confidence": [],
    "request_id": "1521613434,cdc90cd4-ea2e-4bf9-b112-bce711ba2e90",
    "side": "front",
    "time_used": 346
  }
  ```

  

- 切分文件进行比对，同时生成md文件，通过typora导出pdf可视化文件

  ```shell
  #!/bin/bash
  for f in `ls -v *.jpg | grep _ |cut -d_ -f 1 |uniq -c |awk '{print $2}'`
  do
  #echo ${f}_0.jpg
  a=`curl -F image_idcard=@${f}_0.jpg -F image_best=@${f}_1.jpg -F watermark=1 http://10.201.102.104:9000/verify | jq -c -r .confidence`
  echo ![img](http://localhost:8080/${f}_0.jpg) ![img](http://localhost:8080/${f}_1.jpg) >>$a.md 
  #echo ${f}_0.jpg ${f}_1.jpg $a >> a.log
  done

  ```

  ls -v 排序列出所有文件

  grep _ 标记出带有下滑线的

  cut -d _ -f 1 将文件按下划线切分取第一部分

  uniq -c 显示重复的数量和cut -d _ -f 1的部分

  awk '{print $2}' 打印出cut -d _ -f 1部分

  

  

